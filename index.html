<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üç∫ Alcohol Metabolism Calculator - BAC Science Tool</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@3.0.0/index.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            padding: 40px;
            text-align: center;
            color: white;
        }
        
        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        header p {
            font-size: 1.1em;
            opacity: 0.95;
        }
        
        .warning-banner {
            background: #fff3cd;
            border-left: 5px solid #ffc107;
            padding: 15px 20px;
            margin: 20px;
            border-radius: 8px;
            font-size: 0.9em;
            color: #856404;
        }
        
        .content {
            padding: 40px;
        }
        
        .input-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
            font-size: 0.95em;
        }
        
        input, select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            font-family: 'Poppins', sans-serif;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .radio-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        
        .radio-option input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .quick-times {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .quick-time-btn {
            padding: 8px 16px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.3s;
            font-family: 'Poppins', sans-serif;
            color: #667eea;
            font-weight: 500;
        }
        
        .quick-time-btn:hover {
            background: #667eea;
            color: white;
        }
        
        .calculate-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            font-family: 'Poppins', sans-serif;
        }
        
        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
        
        .results-section {
            display: none;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .result-card {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 5px solid #667eea;
        }
        
        .result-card h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 2.5em;
            font-weight: 700;
            color: #667eea;
            font-family: 'Roboto Mono', monospace;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        
        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .chart-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            padding: 10px 20px;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .tab-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .error-bars {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 0.9em;
        }
        
        .legend {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 15px;
            font-size: 0.9em;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        
        .disclaimer {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
            font-size: 0.85em;
            color: #666;
            border: 2px dashed #ddd;
        }
        
        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8em;
            }
            
            .content {
                padding: 20px;
            }
            
            .input-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üç∫ The Sensible Session Planner</h1>
            <p>Understand alcohol metabolism with science! Calculate BAC timelines based on real pharmacokinetics.</p>
        </header>
        
        <div class="warning-banner">
            ‚ö†Ô∏è <strong>Educational Tool:</strong> This calculator demonstrates pharmacokinetic principles of alcohol metabolism using the Widmark equation and standard elimination rates. Individual variation is significant - use for learning, not as personal medical advice!
        </div>
        
        <div class="content">
            <div class="input-section">
                <h2 style="margin-bottom: 20px; color: #667eea;">üìã Session Details</h2>
                
                <div class="input-grid">
                    <div class="input-group">
                        <label>Sex (affects metabolism)</label>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="sex" value="male" checked>
                                <span>Male</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="sex" value="female">
                                <span>Female</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label>Body Weight (kg)</label>
                        <input type="number" id="weight" value="90" min="40" max="200" step="1">
                    </div>
                </div>
                
                <div class="input-grid">
                    <div class="input-group">
                        <label>Session Start</label>
                        <input type="datetime-local" id="sessionStart">
                    </div>
                    
                    <div class="input-group">
                        <label>Session End</label>
                        <input type="datetime-local" id="sessionEnd">
                    </div>
                </div>
                
                <div class="input-group" style="margin-top: 20px;">
                    <label>Need to be Sober By</label>
                    <input type="datetime-local" id="soberBy">
                    <div class="quick-times">
                        <button class="quick-time-btn" onclick="setSoberTime(7, 1)">7am Tomorrow</button>
                        <button class="quick-time-btn" onclick="setSoberTime(9, 1)">9am Tomorrow</button>
                        <button class="quick-time-btn" onclick="setSoberTime(12, 1)">12pm Tomorrow</button>
                        <button class="quick-time-btn" onclick="setSoberTime(18, 0)">6pm Today</button>
                    </div>
                </div>
                
                <div class="input-group" style="margin-top: 20px;">
                    <label>What are you drinking?</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="drinkType" value="beer" checked>
                            <span>üç∫ Beer (4.5% ABV, 568ml pints)</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="drinkType" value="spirits">
                            <span>ü•É Spirits (45% ABV, 25ml shots)</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="drinkType" value="wine">
                            <span>üç∑ Wine (12% ABV, 175ml glasses)</span>
                        </label>
                    </div>
                </div>
                
                <button class="calculate-btn" onclick="calculateSession()">üß™ Calculate My Session</button>
            </div>
            
            <div class="results-section" id="results">
                <div class="result-card">
                    <h2>üìä Your Drinking Strategy</h2>
                    <div class="stats-grid" id="mainStats"></div>
                </div>
                
                <div class="result-card">
                    <h2>üìà Blood Alcohol Content Over Time</h2>
                    <div class="chart-tabs">
                        <button class="tab-btn active" onclick="switchChart('steady')">Steady Pace</button>
                        <button class="tab-btn" onclick="switchChart('frontload')">Heavy Start</button>
                        <button class="tab-btn" onclick="switchChart('backload')">Slow Start</button>
                    </div>
                    <div class="chart-container">
                        <canvas id="bacChart"></canvas>
                    </div>
                    <div class="error-bars">
                        <strong>üìè Error Margins:</strong> Individual metabolism can vary by ¬±20%. The calculations include conservative estimates with a safety margin. Factors like food intake, hydration, and individual health significantly affect alcohol metabolism.
                    </div>
                </div>
                
                <div class="result-card">
                    <h2>üî¨ The Science</h2>
                    <div id="scienceExplanation"></div>
                </div>
            </div>
            
            <div class="disclaimer">
                <strong>Educational Note:</strong> This tool demonstrates alcohol pharmacokinetics using established scientific models. 
                It assumes absorption is complete and instantaneous (reality: 30-90 minutes), uniform distribution (reality: varies by tissue), 
                and zero-order elimination kinetics (mostly accurate for low-moderate BAC). Real-world factors include: gastric emptying time, 
                food content, genetic polymorphisms in ADH/ALDH enzymes, hepatic function, body composition, and chronopharmacological effects. 
                This is a teaching tool - consult medical literature for clinical applications. The Widmark formula dates to 1932 but remains 
                the forensic standard for BAC estimation worldwide.
            </div>
        </div>
    </div>
    
    <script>
        // Initialize datetime inputs with current time
        const now = new Date();
        const dateString = now.toISOString().slice(0, 16);
        document.getElementById('sessionStart').value = dateString;
        
        const twoHoursLater = new Date(now.getTime() + 2 * 60 * 60 * 1000);
        document.getElementById('sessionEnd').value = twoHoursLater.toISOString().slice(0, 16);
        
        const tomorrow7am = new Date(now);
        tomorrow7am.setDate(tomorrow7am.getDate() + 1);
        tomorrow7am.setHours(7, 0, 0, 0);
        document.getElementById('soberBy').value = tomorrow7am.toISOString().slice(0, 16);
        
        let currentChart = null;
        let chartData = {};
        
        function setSoberTime(hour, daysAhead) {
            const date = new Date();
            date.setDate(date.getDate() + daysAhead);
            date.setHours(hour, 0, 0, 0);
            document.getElementById('soberBy').value = date.toISOString().slice(0, 16);
        }
        
        function calculateSession() {
            // Get inputs
            const sex = document.querySelector('input[name="sex"]:checked').value;
            const weight = parseFloat(document.getElementById('weight').value);
            const sessionStart = new Date(document.getElementById('sessionStart').value);
            const sessionEnd = new Date(document.getElementById('sessionEnd').value);
            const soberBy = new Date(document.getElementById('soberBy').value);
            const drinkType = document.querySelector('input[name="drinkType"]:checked').value;
            
            // Validation
            if (sessionEnd <= sessionStart) {
                alert('Session end must be after session start!');
                return;
            }
            
            if (soberBy <= sessionEnd) {
                alert('Sober time must be after session ends!');
                return;
            }
            
            // Constants
            const widmarkR = sex === 'male' ? 0.68 : 0.55; // Body water constant
            const metabolismRate = 0.015; // BAC reduction per hour (standard rate)
            
            // Drink specifications (grams of alcohol per serving)
            const drinks = {
                beer: { name: 'Pint', volume: 568, abv: 0.045, gramsPerServing: 568 * 0.045 * 0.789 },
                spirits: { name: 'Shot', volume: 25, abv: 0.45, gramsPerServing: 25 * 0.45 * 0.789 },
                wine: { name: 'Glass', volume: 175, abv: 0.12, gramsPerServing: 175 * 0.12 * 0.789 }
            };
            
            const drink = drinks[drinkType];
            
            // Calculate session duration and total time until sober
            const sessionDurationHours = (sessionEnd - sessionStart) / (1000 * 60 * 60);
            const totalTimeToSober = (soberBy - sessionStart) / (1000 * 60 * 60);
            const metabolismTimeHours = (soberBy - sessionEnd) / (1000 * 60 * 60);
            
            /*
             * SCIENTIFIC CALCULATION - Working backwards from sober time
             * 
             * We need to find the maximum number of drinks such that:
             * 1. All drinks are consumed during the session (between start and end)
             * 2. BAC reaches exactly 0% at the sober-by time (including upper error margin)
             * 
             * The critical insight: The LAST drink consumed will take the longest to metabolize.
             * If we drink at sessionEnd, we need metabolismTimeHours to fully metabolize.
             * 
             * For worst-case (upper error margin = 20% slower metabolism):
             * - Effective metabolism rate = 0.015 / 1.2 = 0.0125% per hour
             * 
             * Algorithm:
             * 1. Calculate BAC per drink: BAC_per_drink = (grams / (weight_kg * 1000 * r)) * 100
             * 2. Find max drinks where last drink at sessionEnd reaches 0 BAC by soberBy
             * 3. Each drink contributes to total BAC, but older drinks have more time to metabolize
             */
            
            // BAC per drink (peak BAC immediately after consumption)
            const bacPerDrink = (drink.gramsPerServing / (weight * 1000 * widmarkR)) * 100;
            
            // Worst case metabolism rate (20% slower for upper error bound)
            const worstCaseMetabolismRate = metabolismRate / 1.2;
            
            // Binary search for maximum drinks
            let maxDrinks = 0;
            
            // Try different numbers of drinks and simulate BAC at sober time
            for (let numDrinks = 1; numDrinks <= 50; numDrinks++) {
                // Simulate evenly spaced drinking (steady pace)
                let bacAtSoberTime = 0;
                
                for (let i = 0; i < numDrinks; i++) {
                    // When is this drink consumed?
                    const drinkTime = sessionStart.getTime() + (i * (sessionEnd - sessionStart) / numDrinks);
                    const drinkTimeDate = new Date(drinkTime);
                    
                    // How much time to metabolize from drink time to sober time?
                    const hoursToMetabolize = (soberBy - drinkTimeDate) / (1000 * 60 * 60);
                    
                    // BAC from this drink at sober time (worst case)
                    const remainingBAC = Math.max(0, bacPerDrink - (hoursToMetabolize * worstCaseMetabolismRate));
                    
                    bacAtSoberTime += remainingBAC;
                }
                
                // If we're still sober (BAC ~= 0) at the target time, this is safe
                if (bacAtSoberTime < 0.001) { // Effectively zero
                    maxDrinks = numDrinks;
                } else {
                    // We've exceeded safe limits
                    break;
                }
            }
            
            // Store calculation data
            chartData = {
                sessionStart,
                sessionEnd,
                soberBy,
                maxDrinks,
                drink,
                weight,
                widmarkR,
                metabolismRate,
                worstCaseMetabolismRate,
                sessionDurationHours,
                metabolismTimeHours,
                totalTimeToSober,
                bacPerDrink
            };
            
            // Display results
            displayResults(maxDrinks, drink.name, sessionStart, sessionEnd, soberBy, sessionDurationHours);
            
            // Generate charts
            generateChart('steady');
            
            // Show results
            document.getElementById('results').style.display = 'block';
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }
        
        function displayResults(maxDrinks, drinkName, sessionStart, sessionEnd, soberBy, sessionDurationHours) {
            const drinksPerHour = (maxDrinks / sessionDurationHours).toFixed(1);
            
            const statsHTML = `
                <div class="stat-box">
                    <div class="stat-value">${maxDrinks}</div>
                    <div class="stat-label">${drinkName}s Total</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">${drinksPerHour}</div>
                    <div class="stat-label">${drinkName}s/Hour</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">${sessionDurationHours.toFixed(1)}h</div>
                    <div class="stat-label">Session Duration</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">${chartData.metabolismTimeHours.toFixed(1)}h</div>
                    <div class="stat-label">Recovery Time</div>
                </div>
            `;
            
            document.getElementById('mainStats').innerHTML = statsHTML;
            
            const scienceHTML = `
                <p style="margin-bottom: 15px;">
                    <strong>üß™ The Widmark Formula:</strong> BAC = (A / (W √ó r)) √ó 100, where:<br>
                    ‚Ä¢ A = grams of pure alcohol consumed<br>
                    ‚Ä¢ W = body weight in grams (you: ${weight * 1000}g)<br>
                    ‚Ä¢ r = body water distribution ratio (you: ${chartData.widmarkR})<br>
                    ‚Ä¢ Each ${chartData.drink.name} = ${chartData.drink.gramsPerServing.toFixed(1)}g alcohol
                </p>
                <p style="margin-bottom: 15px;">
                    <strong>‚è±Ô∏è Metabolism Rate:</strong> Alcohol is metabolized at approximately ${chartData.metabolismRate * 100}% BAC per hour 
                    via hepatic alcohol dehydrogenase. This is relatively constant and cannot be accelerated by coffee, cold showers, or exercise. 
                    One standard drink (~10g alcohol) takes about 1 hour to metabolize.
                </p>
                <p style="margin-bottom: 15px;">
                    <strong>üî¨ Calculation Method:</strong> This tool works <em>backwards</em> from your sober time. 
                    For each drink consumed at time T, we calculate when it will be fully metabolized. The constraint is that 
                    ALL drinks must be metabolized by your target time. We account for the worst-case scenario (20% slower metabolism) 
                    to ensure safety even with individual variation.
                </p>
                <p style="margin-bottom: 15px;">
                    <strong>üìä Per Drink BAC:</strong> Each ${chartData.drink.name} produces approximately ${chartData.bacPerDrink.toFixed(4)}% BAC 
                    in your body (peak level). This takes ${(chartData.bacPerDrink / chartData.metabolismRate).toFixed(1)} hours to fully metabolize 
                    (${(chartData.bacPerDrink / chartData.worstCaseMetabolismRate).toFixed(1)} hours worst-case).
                </p>
                <p style="margin-bottom: 15px;">
                    <strong>‚ö° Key Variables:</strong>
                    ‚Ä¢ Session duration: ${chartData.sessionDurationHours.toFixed(2)} hours<br>
                    ‚Ä¢ Recovery time: ${chartData.metabolismTimeHours.toFixed(2)} hours<br>
                    ‚Ä¢ Total time: ${chartData.totalTimeToSober.toFixed(2)} hours<br>
                    ‚Ä¢ Max safe drinks: ${chartData.maxDrinks} √ó ${chartData.drink.name}s
                </p>
                <p style="margin-bottom: 15px;">
                    <strong>üéØ Why Different Patterns Matter:</strong> The timing of consumption dramatically affects metabolism. 
                    Drinks consumed early have more time to metabolize. Frontloading (heavy start) means your last drinks have maximum 
                    metabolism time. Backloading (slow start) means your final drinks have minimal time to clear before your deadline.
                </p>
                <p>
                    <strong>‚ö†Ô∏è Real-World Factors:</strong> Food (especially fats/proteins) slows absorption by 30-50%. 
                    Hydration, medications, liver health, and genetics all affect metabolism. Asian populations often have 
                    less efficient aldehyde dehydrogenase (ALDH2 deficiency). This calculator assumes optimal conditions!
                </p>
            `;
            
            document.getElementById('scienceExplanation').innerHTML = scienceHTML;
        }
        
        function generateChart(pattern) {
            const { sessionStart, sessionEnd, soberBy, maxDrinks, drink, weight, widmarkR, metabolismRate } = chartData;
            
            // Generate drinking schedule based on pattern
            let drinkTimes = [];
            const sessionDurationMs = sessionEnd - sessionStart;
            
            if (pattern === 'steady') {
                // Evenly spaced
                for (let i = 0; i < maxDrinks; i++) {
                    drinkTimes.push(new Date(sessionStart.getTime() + (i * sessionDurationMs / maxDrinks)));
                }
            } else if (pattern === 'frontload') {
                // 60% in first half, 40% in second half
                const firstHalfDrinks = Math.ceil(maxDrinks * 0.6);
                const firstHalfDuration = sessionDurationMs / 2;
                
                for (let i = 0; i < firstHalfDrinks; i++) {
                    drinkTimes.push(new Date(sessionStart.getTime() + (i * firstHalfDuration / firstHalfDrinks)));
                }
                
                const secondHalfDrinks = maxDrinks - firstHalfDrinks;
                for (let i = 0; i < secondHalfDrinks; i++) {
                    drinkTimes.push(new Date(sessionStart.getTime() + firstHalfDuration + (i * firstHalfDuration / secondHalfDrinks)));
                }
            } else if (pattern === 'backload') {
                // 40% in first half, 60% in second half
                const firstHalfDrinks = Math.floor(maxDrinks * 0.4);
                const firstHalfDuration = sessionDurationMs / 2;
                
                for (let i = 0; i < firstHalfDrinks; i++) {
                    drinkTimes.push(new Date(sessionStart.getTime() + (i * firstHalfDuration / firstHalfDrinks)));
                }
                
                const secondHalfDrinks = maxDrinks - firstHalfDrinks;
                for (let i = 0; i < secondHalfDrinks; i++) {
                    drinkTimes.push(new Date(sessionStart.getTime() + firstHalfDuration + (i * firstHalfDuration / secondHalfDrinks)));
                }
            }
            
            // Calculate BAC over time
            const dataPoints = [];
            const startTime = sessionStart.getTime();
            const endTime = soberBy.getTime();
            const timeStep = 15 * 60 * 1000; // 15 minutes
            
            for (let time = startTime; time <= endTime; time += timeStep) {
                const currentTime = new Date(time);
                let bac = 0;
                
                // Add contribution from each drink consumed so far
                drinkTimes.forEach(drinkTime => {
                    if (drinkTime <= currentTime) {
                        const hoursElapsed = (currentTime - drinkTime) / (1000 * 60 * 60);
                        const alcoholGrams = drink.gramsPerServing;
                        const peakBAC = (alcoholGrams / (weight * 1000 * widmarkR)) * 100;
                        const currentBAC = Math.max(0, peakBAC - (hoursElapsed * metabolismRate));
                        bac += currentBAC;
                    }
                });
                
                dataPoints.push({
                    time: currentTime,
                    bac: bac,
                    bacUpper: bac * 1.2, // Upper error bar
                    bacLower: Math.max(0, bac * 0.8) // Lower error bar
                });
            }
            
            // Create chart
            const ctx = document.getElementById('bacChart');
            
            if (currentChart) {
                currentChart.destroy();
            }
            
            currentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dataPoints.map(d => d.time.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })),
                    datasets: [
                        {
                            label: 'Estimated BAC',
                            data: dataPoints.map(d => d.bac),
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Upper Range (+20%)',
                            data: dataPoints.map(d => d.bacUpper),
                            borderColor: '#f5576c',
                            backgroundColor: 'rgba(245, 87, 108, 0.05)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.4
                        },
                        {
                            label: 'Lower Range (-20%)',
                            data: dataPoints.map(d => d.bacLower),
                            borderColor: '#4ecdc4',
                            backgroundColor: 'rgba(78, 205, 196, 0.05)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(3) + '% BAC';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Blood Alcohol Content (%)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(3) + '%';
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    },
                    annotation: {
                        annotations: [
                            {
                                type: 'line',
                                mode: 'horizontal',
                                scaleID: 'y',
                                value: 0.08,
                                borderColor: 'red',
                                borderWidth: 2,
                                borderDash: [10, 5],
                                label: {
                                    content: 'UK Legal Limit (0.08%)',
                                    enabled: true,
                                    position: 'end'
                                }
                            }
                        ]
                    }
                }
            });
        }
        
        function switchChart(pattern) {
            // Update active tab
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Generate new chart
            generateChart(pattern);
        }
    </script>
</body>
</html>